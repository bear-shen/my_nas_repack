<template>
  <div class="dir">
    <div class="info" @click="fetch">
      <div>
        <!--        <a @click.stop="setImport(path)">select</a>-->
        <p :style="{paddingLeft:`${level*20}px`}">
          <span :class="{
            sysIcon:true,
            sysIcon_arrowright:type==='directory' && fold,
            sysIcon_arrowdown:type==='directory' && !fold,
            sysIcon_file:type==='file',
            }"></span>
          <span>{{ path }}</span>
        </p>
      </div>
      <div class="meta">
        <a @click.stop="setDelete(path)">Delete</a>
        <a v-if="type==='directory'" @click.stop="setDir(path)">MKDir</a>
        <a v-if="type==='directory'" @click.stop="setUpload(path)">Upload</a>
        <a v-if="type==='file'" @click.stop="setDownload(path)">Download</a>
        <a v-if="type==='directory'" @click.stop="setImport(path)">Import</a>
        <p>{{ $util.kmgt(size) }}</p>
        <p>{{ type }}</p>
        <p>{{ auth }}</p>
      </div>
    </div>
    <template v-if="!fold">
      <import-files-sub class="sub" v-for="(item,index) in list"
                        :key="`setting_imp_f_${index}`"
                        :path="item.path"
                        :name="item.name"
                        :size="item.size"
                        :type="item.type"
                        :auth="item.auth"
                        :level="level+1"
                        :parent-ls="list"
      >
      </import-files-sub>
      <!--      @submit="setImport"-->
    </template>
  </div>
</template>

<style lang="scss">
.local_file_browser {
  background-color: map-get($colors, list_l2_bk);
  padding: $fontSize*0.5;
  .info {
    display: flex;
    //justify-content: left;
    justify-content: space-between;
    //margin-bottom: $fontSize*0.5;
    //padding-bottom: $fontSize*0.5;
    border-bottom: 1px solid map-get($colors, font_sub);
    p {
      display: inline-block;
      line-height: $fontSize*2;
      margin-left: $fontSize;
    }
    .sysIcon {
      margin-right: $fontSize;
      font-size: $fontSize*0.5;
      color: map-get($colors, font_sub);
    }
    cursor: pointer;
    &:hover {
      background-color: map-get($colors, list_l3_bk);
    }
    div {
      display: flex;
      justify-content: space-between;
    }
    .meta {
      p {
        min-width: $fontSize*5;
      }
    }
  }
  .dir {
  }
}
</style>

<script lang="ts">
import {Options, Vue} from 'vue-class-component'
import {Modal as ModalConstructor, ModalCreatorConfig, ModalFormConstruct} from '@/lib/ModalLib';
import {ModalMeta, Node} from '@/struct';
import ContentEditable from '@/components/ContentEditable.vue';
import config from '@/config';

@Options({
  emits: ['submit'],
  props: {
    path: String,
    name: String,
    size: Number,
    type: String,
    auth: String,
    level: Number,
    parentLs: Array,
  },
  components: {
    ContentEditable,
    // ImportFilesSub,
  },
  data: function () {
    return {
      list: [] as {
        path: string,
        name: string,
        size: number,
        type: string,
        auth: string,
      }[],
      fold: true,
      uploadDOM: null,
    };
  },
  created: function () {
    // console.debug(this);
    return '';
  },
  watch: {},
  mounted: function () {
    return '';
  },
  methods: {
    fetch: async function () {
      if (this.type !== 'directory') return;
      if (!this.fold) {
        this.fold = true;
        return;
      }
      if (this.list.length) {
        this.fold = false;
        return;
      }
      const res = await this.$query('local/ls', {
        path: this.path,
      });
      this.list = res;
      this.fold = false;
    },
    setDelete: async function () {
      // console.info('setDelete');
      const confirmModal = {
        title: `confirm to delete [${this.path}]:`,
        key: 'local_directory_delete_confirm',
        alpha: true,
        single: true,
        //不可移动的不能调整大小
        movable: true,
        resizable: true,
        width: 480,
        height: 140,
        // width: 480,
        // height: 240,
        text: `confirm to delete [${this.path}]`,
        callback: [
          {
            key: 'confirm',
            name: 'confirm',
            callback: (async (form: ModalFormConstruct[], key: string, on: { [key: string]: () => any }) => {
              // console.info(key, on);
              // return;
              await this.$query('local/rm', {
                path: this.path,
              });
              // console.info(this.parentLs);
              for (let i1 = 0; i1 < this.parentLs.length; i1++) {
                if (this.parentLs[i1].path !== this.path) continue;
                this.parentLs.splice(i1, 1);
                break;
              }
              if (on) on.close();
            })
          }
        ]
      } as ModalCreatorConfig;
      this.$store.commit('modal/push', confirmModal);
    },
    setDir: async function () {
      const confirmModal = {
        title: `confirm to mkdir in [${this.path}]:`,
        key: 'local_directory_create_confirm',
        alpha: true,
        single: true,
        //不可移动的不能调整大小
        movable: true,
        resizable: true,
        width: 480,
        height: 140,
        // width: 480,
        // height: 240,
        form: [
          {
            key: 'directory name',
            name: 'directory name',
            type: 'text',
            value: '',
          }
        ],
        callback: [
          {
            key: 'confirm',
            name: 'confirm',
            callback: (async (form: ModalFormConstruct[], key: string, on: { [key: string]: () => any }) => {
              form[0].value = form[0].value.trim();
              const targetPath = `${this.path}/${form[0].value}`;
              if (!form[0].value.length) return;
              // console.info(key, on, targetPath);
              await this.$query('local/mkdir', {
                path: targetPath,
              });
              // console.info(this.parentLs);
              let dup = false;
              for (let i1 = 0; i1 < this.list.length; i1++) {
                if (this.list[i1].path !== targetPath) continue;
                dup = true;
                break;
              }
              await this.fetch();
              if (!dup) {
                this.list.push({
                  path: targetPath,
                  name: form[0].value,
                  size: 0,
                  type: 'directory',
                  auth: '40766',
                });
              }
              if (on) on.close();
            })
          }
        ]
      } as ModalCreatorConfig;
      this.$store.commit('modal/push', confirmModal);
    },
    setUpload: async function () {
      // console.info('setUpload');
      this.createUploadEvt();
    },
    setDownload: async function () {
      // console.info('setDownload');
      window.open(
        `${
          config.content.apiPath
        }local/get?token=${
          localStorage.getItem('toshokan_auth_token')
        }&path=${encodeURIComponent(this.path)}`
      )
    },
    setImport: async function (path: string) {
      //导入A到B
      //A文件夹下的文件导入到B中
      const mvModal = {
        title: `import content in [${this.path}] to:`,
        key: 'local_directory_import_confirm',
        alpha: true,
        single: true,
        //不可移动的不能调整大小
        movable: true,
        resizable: true,
        width: 480,
        height: 240,
        // width: 480,
        // height: 240,
        component: {
          MoveDirectory: {
            item: {
              id: -1,
              id_parent: -1,
            } as Node,
            callback: async (to: Node) => {
              // console.debug(to, this.path);
              // return;
              // console.debug('callback close');
              const res = await this.$query('file/dir_import', {
                dir_path: this.path,
                dir_id: to.id,
              });
            },
          },
        },
      } as ModalCreatorConfig;
      this.$store.commit('modal/push', mvModal);
    },
    createUploadEvt: function () {
      this.uploadDOM = document.createElement('input');
      this.uploadDOM.type = 'file';
      this.uploadDOM.addEventListener('change', this.uploadEvt);
      this.uploadDOM.click();
    },
    uploadEvt: async function (e: any) {
      console.info(e, this.uploadDOM.files);
      if (!this.uploadDOM.files.length) return;
      const file = this.uploadDOM.files[0] as File;
      await this.$query('local/put', {
        path: this.path,
        name: file.name,
        file: file,
      });
      if (this.list.length) {
        this.list.push({
          path: `${this.path}/${file.name}`,
          name: file.name,
          size: file.size,
          type: 'file',
          auth: '40766',
        });
      }
    },
  },
})
export default class ImportFilesSub extends Vue {
}
</script>
